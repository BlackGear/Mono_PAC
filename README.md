# Mono PAC

A PAC(Proxy auto-config) file generator with fetched China IP range, which helps walk around GFW.

Mono generates a much smaller PAC file than any other project does.

## Installation
<pre>
$ git clone https://github.com/BlackGear/Mono_PAC.git
</pre>

## Uasge
<pre>
$ python ./src/make.py -h
usage: MonoPac [-h] [-b blackList] [-w whiteList] [-i ipList] -p proxyList
               [-o pacFile]

Mono Pac Generator

optional arguments:
  -h, --help    show this help message and exit
  -b blackList  Path of the black list
  -w whiteList  Path of the white list
  -i ipList     Path of the iprange list
  -p proxyList  Proxy parameter in the pac file
  -o pacFile    Path of the output pac file

Across the Great Firewall, we can reach every corner in the world.

$ python ./src/make.py -p "SOCKS5 192.168.1.1:1080;SOCKS 192.168.1.1:1080" -o ./proxy.pac
</pre>
Both Python 2 and 3 are supported.

## Details

The Pac works in this way:

1. Grab url and host:

    when you browse https://www.google.com/xxx

    url = https://www.google.com/xxx

    host = www.google.com

2. Match domain:

    test if "www.google.com" in blackList,

    test if "www.google.com" in whiteList,

    test if     "google.com" in blackList,

    test if     "google.com" in whiteList,

    test if            "com" in blackList.

    test if            "com" in whiteList,

    domain in blackList -> proxy

    domain in blackList -> direct

3. Test Dns resolve:

    if dns resolve to the host failed -> proxy

4. Test IP range:

    dns resolve the host.

    if IP in any range in ipList -> direct

    others -> proxy

### blackList:

One domains per line.

### whiteList:

One domains per line.

### ipList:

One record per line with IP/CIDR format.

### proxyList:

Proxy Configs separated by ";".

Available proxy configs:
<pre>
PROXY host:port   = use HTTP proxy
SOCKS5 host:port  = use Socks5 proxy
DIRECT            = Do not use proxy
</pre>

Example: "PROXY 127.0.0.1:8080;DIRECT"

Note: The latter config is the fallback of the former one. There is no limit on the length of the fallback list.

Note: Safari do not understand "SOCKS5", use "SOCKS" instead, you can also use a more compatible form like: "SOCKS5 host:port;SOCKS host:port", Safari will ignore the first config and use the second as a fallback.

Note: The last DIRECT have a potential risk cause the dns pollution will affect the domains in the blackList.

Note: When you use socks proxy, whether dns resolve will through the proxy is determined by the Apps itself. When you use http proxy, the dns resolve will always through the proxy.

## Performance
Performance with Node.js:
<pre>
$ ./performance_test.sh
Testing pac generated by BlackGear/Mono_Pac
avg: 2.268us

Testing pac generated by breakwa11/gfw_whitelist
avg: 4.331us

Testing pac generated by Leask/flora_pac
avg: 145.960us

Testing pac generated by Leask/flora_pac-mod
avg: 4.781us

Testing pac generated by usufu/flora_pac
avg: 2.939us

-rw-r--r--  1 Daniel  staff   45662  2 24 21:53 BlackGear-Mono_Pac.pac
-rw-r--r--  1 Daniel  staff  165129  2 24 21:53 Leask-Flora_Pac-mod.pac
-rw-r--r--  1 Daniel  staff   74738  2 24 21:53 Leask-Flora_Pac.pac
-rw-r--r--  1 Daniel  staff   92854  2 24 21:53 breakwa11-gfw_whitelist.pac
-rw-r--r--  1 Daniel  staff  254539  2 24 21:53 usufu-Flora_Pac.pac
</pre>

Performance with Safari:
<pre>
Testing pac generated by BlackGear/Mono_Pac
Average 192.78ms in 100,000 tests

Testing pac generated by breakwa11/gfw_whitelist
Average 463.54ms in 100,000 tests

Testing pac generated by Leask/flora_pac
Average 4934.83ms in 100,000 tests

Testing pac generated by Leask/flora_pac-mod
Average 400.81ms in 100,000 tests

Testing pac generated by usufu/flora_pac
Average 281.89ms in 100,000 tests
</pre>

## Conclusion

- MonoPac is the smallest one with a full ipList. It's even smaller than Flora_Pac with a minimal ipList.

Leask-Flora_Pac.pac use a minimal ipList ignored the last two bytes of every ip, while others use a full ipList.

- MonoPac is the fastest one with full functions. It's even faster than gfw_whitelist with a minimal functions.

breakwa11-gfw_whitelist.pac does not check if domain in white or black list. while others use the same O(1) algorithm to check the domains white or black list.

## Trivia

The code in the root scope of the PAC file will be run only once.

The code in the FindProxyForURL function's scope will be run each time you browser the internet.

Just test this two PAC files:

<pre>
    var unixtime_ms = new Date().getTime();
    while(new Date().getTime() &lt; unixtime_ms + 5000) {}
    function FindProxyForURL(url, host) {
        return "DIRECT;";
    }
</pre>

<pre>
    function FindProxyForURL(url, host) {
        var unixtime_ms = new Date().getTime();
        while(new Date().getTime() &lt; unixtime_ms + 5000) {}
        return "DIRECT;";
    }
</pre>

So put all var xx = yy in the root scope will accelerate the PAC file.

PS: if code in the root scope of the PAC file will be run many times, we should put the var inside the FindProxyForURL just before it being used.

## Compress

Experimental compress feature are used in branchs.

### master / develop

PAC file is compressed with uglifyjs 2:

<pre>
$ uglifyjs mono.js -m toplevel -r FindProxyForURL -c -o mono.min.js
</pre>

### lz

Use lz-string to compress the ip range list, 40% space savings, 20% performance loss.

### unicode

Use unicode black magic to compress ip range list, 50% space savings, 10% performance loss.

### objgen

Dynamic object generation to compress domain list.

## LICENSE
The MIT License

Copyright (c) 2015 Daniel

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
